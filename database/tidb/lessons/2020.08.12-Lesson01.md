# **High Performance TiDB** 第一课 （交作业）

<center>

<iframe
    src="//player.bilibili.com/player.html?bvid=BV17K411T7Kd&page=1"
    sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"
    scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true">
</iframe>

[【High Performance TiDB】Lesson 01：TiDB 整体架构](https://www.bilibili.com/video/BV17K411T7Kd)

</center>

<!-- more -->

## 💻 一、准备开发环境

#### 操作系统

```text
First, 看了下三个项目在线源码
Hmm， 有一些sh文件
Ok, 虚拟机安装个 Manjaro Linux， 分配2C8G
```

#### 编译环境

> 参考 ·[setting-up-your-development-environment](https://github.com/pingcap/community/blob/master/contributors/README.md#setting-up-your-development-environment)

```shell
# 基本需要
sudo pacman -S git gcc clang llvm make cmake

# TiKV 需要
sudo pacman -S rustup

# TiDB & PD 需要
sudo pacman -S go

# 配置go模块代理
go env -w GO111MODULE=on
go env -w GOPROXY=https://goproxy.io,direct
```

## 📥 二、下载 `TiDB`, `TiKV`, `PD` 源代码

#### 准备好工作目录

```shell
# Workspace
Workspace=/opt/Projects
mkdir ${Workspace} -p
cd ${Workspace}
```

#### 克隆代码

> 这里直接克隆了官方仓库， 后面提交 PR 的时候应该要先 Fork

```shell
# TiKV
git clone --recursive https://github.com/tikv/tikv.git

# TiDB
git clone --recursive https://github.com/pingcap/tidb.git

# PD
git clone --recursive https://github.com/pingcap/pd.git
```

## 📜 三、构建和测试

> 克隆代码后， 先把每个项目都编译构建一次，确保一切正常

#### TiKV

```shell
cd ${Workspace}/tikv

# 配置RUST工具链
rustup component add rustfmt
rustup component add clippy

# 构建和测试
make build
# 这个编译时间有点久
# Finished dev [unoptimized + debuginfo] target(s) in 31m 38s
# Ok，用时半个多小时

cargo check -all

```

#### PD

```shell
cd ${Workspace}/pd
make
```

#### TiDB

```shell
cd ${Workspace}/tidb
make
# 这个编译完成可以看到 Build TiDB Server successfully!
```

## 🚀 四、启动服务

> Ok，三个项目都已经构建通过，启动服务，跑起来看一下

## 📝 五、修改

> 需求: `TiDB` 启动事务时, 输出一个`"hello transaction"`的日志 </br>

> 惭愧， 学过 Rust 还没学 Go，接下来要学下 Golang 了

#### 🚩 定位

> `//TODO 待更新`

#### ✏️ 修改并测试

> `//TODO 待更新`

## ✍️ 六、问题总结

> 目前都是网络问题

#### crates.io 有点慢(超时)， 替换[中科大]国内源

```shell
tee $HOME/.cargo/config <<-'EOF'
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'ustc'
[source.ustc]
registry = "git://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

#### 构建过程拉取部分 Github 仓库源码时一直超时错误

```text
Linux翻墙有些麻烦， 用手机热点解决。
```
