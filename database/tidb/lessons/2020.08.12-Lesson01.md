
<!-- tags: pingcap, tidb -->
<!-- created: 2020-08-12 18:00 -->

# **High Performance TiDB** ç¬¬ä¸€è¯¾

<center>

<!-- iframe 
<iframe
    src="//player.bilibili.com/player.html?bvid=BV17K411T7Kd&page=1"
    sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"
    scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true">
</iframe>
 -->

[ã€High Performance TiDBã€‘Lesson 01ï¼šTiDB æ•´ä½“æ¶æ„](https://www.bilibili.com/video/BV17K411T7Kd)

</center>

> æœ¬èŠ‚è¯¾ç¨‹ä½œä¸º High Performance TiDB è¯¾ç¨‹ç³»åˆ—çš„ç¬¬ä¸€èŠ‚è¯¾ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š </br>
> 
> 1. å¯¹ High Performance TiDB è¯¾ç¨‹å‘èµ·èƒŒæ™¯çš„ä»‹ç»
> 2. å¯¹ High Performance TiDB è¯¾ç¨‹è®¾è®¡çš„ç®€è¦ä»‹ç»ï¼ŒåŒ…æ‹¬è¯¾ç¨‹ç›®æ ‡ã€å—ä¼—ã€è€ƒæ ¸æ–¹å¼ç­‰
> 3. å¯¹ TiDB æ•´ä½“æ¶æ„çš„ä»‹ç»
> 
<!-- more -->

## ğŸ’» ä¸€ã€å‡†å¤‡å¼€å‘ç¯å¢ƒ

#### æ“ä½œç³»ç»Ÿ

```text
First, ç°å¤§æ¦‚çœ‹äº†ä¸‹ä¸‰ä¸ªé¡¹ç›®åœ¨çº¿æºç å’Œæ–‡æ¡£ï¼Œ
Hmmï¼Œ`Makefile`, `sh`, `llvm` å•¥çš„ï¼Œ è¿˜æ˜¯ç”¨Linuxå§
Ok, MBPåˆšå¥½æ‹¿å»ä¿®äº†ï¼Œ è™šæ‹Ÿæœºå®‰è£…ä¸ª Manjaro Linuxï¼Œ åˆ†é…2C8G
```

#### ç¼–è¯‘ç¯å¢ƒ

> å‚è€ƒ Â·[setting-up-your-development-environment](https://github.com/pingcap/community/blob/master/contributors/README.md#setting-up-your-development-environment)

```bash
# åŸºæœ¬éœ€è¦
sudo pacman -S git gcc clang llvm make cmake

# TiKV éœ€è¦
sudo pacman -S rustup

# TiDB & PD éœ€è¦
sudo pacman -S go

# é…ç½®goæ¨¡å—ä»£ç†
go env -w GO111MODULE=on
go env -w GOPROXY=https://goproxy.io,direct
```

## ğŸ“¥ äºŒã€ä¸‹è½½ `TiDB`, `TiKV`, `PD` æºä»£ç 

#### å‡†å¤‡å¥½å·¥ä½œç›®å½•

```bash
# Workspace
Workspace=/opt/Projects
mkdir ${Workspace} -p
cd ${Workspace}
```

#### å…‹éš†ä»£ç 

> è¿™é‡Œç›´æ¥å…‹éš†äº†å®˜æ–¹ä»“åº“ï¼Œ åé¢æäº¤ PR çš„æ—¶å€™åº”è¯¥è¦å…ˆ Fork

```bash
# TiKV
git clone --recursive https://github.com/tikv/tikv.git

# TiDB
git clone --recursive https://github.com/pingcap/tidb.git

# PD
git clone --recursive https://github.com/pingcap/pd.git
```

## ğŸ“œ ä¸‰ã€æ„å»ºå’Œæµ‹è¯•

> å…‹éš†ä»£ç åï¼Œ å…ˆæŠŠæ¯ä¸ªé¡¹ç›®éƒ½ç¼–è¯‘æ„å»ºä¸€æ¬¡ï¼Œç¡®ä¿ä¸€åˆ‡æ­£å¸¸

#### TiKV

```bash
cd ${Workspace}/tikv

# é…ç½®RUSTå·¥å…·é“¾
rustup component add rustfmt
rustup component add clippy

# æ„å»ºå’Œæµ‹è¯•
make build
# è¿™ä¸ªç¼–è¯‘æ—¶é—´æœ‰ç‚¹ä¹…
# Finished dev [unoptimized + debuginfo] target(s) in 31m 38s
# Okï¼Œç”¨æ—¶åŠä¸ªå¤šå°æ—¶

cargo check -all

```

#### PD

```bash
cd ${Workspace}/pd
make
```

#### TiDB

```bash
cd ${Workspace}/tidb
make
# è¿™ä¸ªç¼–è¯‘å®Œæˆå¯ä»¥çœ‹åˆ° Build TiDB Server successfully!
```

## ğŸš€ å››ã€å¯åŠ¨æœåŠ¡

> Okï¼Œä¸‰ä¸ªé¡¹ç›®éƒ½å·²ç»æ„å»ºé€šè¿‡ï¼Œå¯åŠ¨æœåŠ¡ï¼Œå…ˆè·‘èµ·æ¥çœ‹ä¸€ä¸‹

> PDå’ŒTiKVå‚è€ƒï¼š https://github.com/tikv/tikv/blob/master/docs/how-to/deploy/using-binary.md </br>
> TiDBå‚è€ƒï¼š https://pingcap.com/blog/building-running-and-benchmarking-tikv-and-tidb/

```bash
# è®¾ç½®ä¸€ä¸ªè¿è¡Œç›®å½•
mkdir -p /opt/cluster
cd /opt/cluster
```

#### å¯åŠ¨ PD*1

> å‚æ•°é…ç½®è¯´æ˜ï¼š https://docs.pingcap.com/zh/tidb/stable/command-line-flags-for-pd-configuration

```bash
PD=${Workspace}/pd/bin

${PD}/pd-server --name=pd1 \
                --data-dir=pd1 \
                --client-urls="http://127.0.0.1:2379" \
                --peer-urls="http://127.0.0.1:2380" \
                --initial-cluster="pd1=http://127.0.0.1:2380" \
                --log-file=pd1.log
```

#### å¯åŠ¨ TiKV*3

> å‚æ•°é…ç½®è¯´æ˜ï¼š https://docs.pingcap.com/zh/tidb/stable/command-line-flags-for-tikv-configuration

```bash
TIKV=${Workspace}/tikv/target/debug

${TIKV}/tikv-server --pd-endpoints="127.0.0.1:2379" \
                --addr="127.0.0.1:20160" \
                --data-dir=tikv1 \
                --log-file=tikv1.log

${TIKV}/tikv-server --pd-endpoints="127.0.0.1:2379" \
                --addr="127.0.0.1:20161" \
                --data-dir=tikv2 \
                --log-file=tikv2.log

${TIKV}/tikv-server --pd-endpoints="127.0.0.1:2379" \
                --addr="127.0.0.1:20162" \
                --data-dir=tikv3 \
                --log-file=tikv3.log
```
#### éªŒè¯TiKVçŠ¶æ€

```bash
# pd-ctl docï¼š https://tikv.org/docs/4.0/reference/tools/pd-ctl/
${Workspace}/pd/bin/pd-ctl store -u http://127.0.0.1:2379

# Ok. çœ‹åˆ°è¾“å‡ºä¸€å—JSONæ•°æ®ï¼Œä¸‰ä¸ªèŠ‚ç‚¹å…¨éƒ¨ "state_name:"up"
```

#### å¯åŠ¨ TiDB*1

> å‚æ•°é…ç½®è¯´æ˜ï¼š https://docs.pingcap.com/zh/tidb/stable/command-line-flags-for-tidb-configuration

```bash
TIDB=${Workspace}/tidb/bin
${TIDB}/tidb-server --store=tikv \
                --path="127.0.0.1:2379" \
                --log-file=tidb1.log
# æ³¨æ„ï¼š --pathå‚æ•°ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™
```

#### éªŒè¯TiDBçŠ¶æ€

```bash
sudo pacman -S mariadb

mysql -h 127.0.0.1 -P 4000 -u root
# è¾“å‡º
# Welcome to the MariaDB monitor.  Commands end with ; or \g.
# Your MySQL connection id is 16
# Server version: 5.7.25-TiDB-v4.0.0-beta.2-953-gbaedc336a # TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 # compatible
# 
# Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and # others.
# 
# Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.
# 
# MySQL [(none)]> 
# 
```

#### Dashboard

> `{pd-ip}:{pd-port}/dashboard `

![Dashboard Screenshot](./2020.08.12-Lesson01/2020.08.12-Lesson01-dashboard.png)

## ğŸ“ äº”ã€ä¿®æ”¹

> éœ€æ±‚: ä¿®æ”¹æºç å¹¶éƒ¨ç½²(1 TiDB, 1 PD, 3 TiKV)ï¼Œ ä½¿`TiDB` å¯åŠ¨äº‹åŠ¡æ—¶, è¾“å‡ºä¸€ä¸ª`"hello transaction"`çš„æ—¥å¿— </br>

> æƒ­æ„§ï¼Œ å­¦è¿‡ Rust è¿˜æ²¡å­¦ Goï¼Œæ¥ä¸‹æ¥è¦å­¦ä¸‹ Golang äº†

#### å®šä½

```go
// å…ˆæ‰¾åˆ°ç¨‹åºå…¥å£ï¼šå¯åŠ¨ç”¨çš„ tidb-serverï¼Œ é‚£ä¹ˆå…ˆçœ‹ä¸‹tidb-server/main.go
// æ‰¾åˆ° func main, æœ‰ä¸ª runServer()ï¼Œè·³è¿‡å»ï¼Œ æœ‰ä¸ªsvr.Run(), å†è·³
// æœ‰ä¸ª for å¾ªç¯çš„ s.listener.Accept()ï¼Œ åº”è¯¥æ˜¯å®¢æˆ·ç«¯ç›‘å¬ï¼Œ å¾€ä¸‹ç¿»ï¼Œ
// æœç„¶ï¼Œ clientConn := s.newConn(conn)
// å†ç¿»ï¼Œ go s.onConn(clientConn)ï¼Œ è·³è¿‡å»ï¼Œ
// æ‰¾åˆ°ä¸€ä¸ª conn.Run(ctx)ï¼Œ è·³è¿‡å»
// data, err := cc.readPacket() åº”è¯¥æ˜¯ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®
// cc.dispatch(ctx, data) åº”è¯¥æ˜¯ä¸‹æ¨ï¼Œ è·³è¿‡å»çœ‹ä¸‹
// æœ‰ä¸ª switch cmd { /*case ä¸€å †å‘½ä»¤ç±»å‹*/  }ï¼Œ æ˜¯åœ¨è§£æ
// case mysql.ComQuery è¢«æ³¨é‡Šé«˜é¢‘ä½¿ç”¨ï¼Œ 
// cc.handleQuery(ctx, dataStr) è·³è¿‡å»çœ‹ä¸‹ï¼Œ
// çœ‹æ³¨é‡Š  æ˜¯ä¸€ä¸ªæ‰§è¡ŒæŸ¥è¯¢è¯­å¥å’Œè¿”å›ç»“æœçš„å‡½æ•°
// è·Ÿè¸ªä¸€ä¸‹ stmts å˜é‡ï¼Œ for å¾ªç¯ cc.handleStmt å¤„ç†ï¼Œ è·³è¿‡å»ï¼Œ
// å›§ï¼Œ æ²¡æœ‰æ³¨é‡Šï¼Œ ç¿»ç¿»çœ‹ã€‚ã€‚ã€‚
// æœ‰ä¸ª cc.ctx.ExecuteStmtï¼Œç›´æ¥è·³è¿‡å»
// tc.Session.ExecuteStmtï¼Œ å†è·³ï¼Œ 
// é¢ï¼Œ æ˜¯ä¸ªæ¥å£

// æ£€ç´¢ä¸€ä¸‹ é‚£ä¸ª ExecuteStmtï¼Œ ç¿»äº†ç¿»
// çœ‹åˆ°session.go çš„ ExecuteStmt å‡½æ•°ä¸­æœ‰ä¸€å¥ s.PrepareTxnCtx(ctx)
// å®ƒä¼šåˆ›å»ºäº‹ç‰©ä¸Šä¸‹æ–‡ï¼Œ æ‰§è¡ŒSQLè¯­å¥å‰è¢«è°ƒç”¨
// å­—é¢æ„æ€ï¼Œ è¿™é‡Œåªæ˜¯åˆ›å»ºï¼Œ å‡†å¤‡ï¼Œ è¿˜æ²¡å¼€å¯äº‹åŠ¡

// å¾€ä¸‹æ‰¾ï¼Œ çœ‹åˆ° rs, err = s.Exec(ctx) å’Œ recordSet, err := runStmt(ctx, s, stmt)ï¼Œ
// æœç´¢Exec(ctxï¼Œ åœ¨ adapter.go ä¸­æ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œ 
// å†çœ‹åˆ°ä¸€ä¸ª txn, err := sctx.Txn(false) å’Œ txnStartTS = txn.StartTS()æ—¶ï¼Œ åº”è¯¥æ˜¯äº‹åŠ¡å¯åŠ¨æ—¶é—´
// é‚£ä¹ˆäº‹åŠ¡å¯åŠ¨åº”è¯¥åœ¨é™„è¿‘ï¼Œ ç‚¹å¼€ sctx.Txn(false);
// çœ‹åˆ°
type Context interface {
	// NewTxn creates a new transaction for further execution.
	// If old transaction is valid, it is committed first.
	// It's used in BEGIN statement and DDL statements to commit old transaction.
	NewTxn(context.Context) error

	// Txn returns the current transaction which is created before executing a statement.
	// The returned kv.Transaction is not nil, but it maybe pending or invalid.
	// If the active parameter is true, call this function will wait for the pending txn
	// to become valid.
	Txn(active bool) (kv.Transaction, error)
	
	// ...
	
	
	// InitTxnWithStartTS initializes a transaction with startTS.
	// It should be called right before we builds an executor.
	InitTxnWithStartTS(startTS uint64) error
	
	// ...
}

// çœ‹åˆ° InitTxnWithStartTS æ–¹æ³•ï¼Œ æ ¹æ®æ³¨é‡Šï¼Œ å®ƒä¼šåœ¨åˆ›å»ºæ‰§è¡Œå™¨å‰è°ƒç”¨
// æ­£å¸¸æ¥è¯´äº‹åŠ¡å¼€å§‹çš„æ—¶å€™è¦è®°å½•å¼€å§‹æ—¶é—´ï¼Œ é‚£ä¹ˆåè¿‡æ¥è¯´ï¼Œèµ‹äºˆå¼€å§‹æ—¶é—´çš„æ—¶å€™ï¼Œ åº”è¯¥ä¹Ÿæ˜¯äº‹åŠ¡å¼€å§‹çš„æ—¶å€™
// æ£€ç´¢ä¸€ä¸‹ InitTxnWithStartTSï¼Œ çœ‹åˆ°adapter.go ä¸­åˆ›å»ºæ‰§è¡Œå™¨ buildExecutor æ–¹æ³•ä¸­æœ‰è°ƒç”¨ï¼Œ
// å†ç¿»ä¸‹æ£€ç´¢ç»“æœï¼Œ çœ‹åˆ° session.go å’Œ context.go ä¸‹éƒ½å®ç°äº† InitTxnWithStartTS æ–¹æ³•
// è€Œ context.go åœ¨mockåŒ…ä¸‹ï¼Œ  æ˜¾ç¤ºæ³¨é‡Šä¸º Package mock is just for test only. é‚£ä¹ˆä¸ç®¡å®ƒ
// æ¥çœ‹ä¸€ä¸‹ session.go ä¸‹çš„ InitTxnWithStartTS å®ç°ï¼Œ
func (s *session) InitTxnWithStartTS(startTS uint64) error {
	// ...
	txn, err := s.store.BeginWithStartTS(startTS)
	// ...
}
// æœ€ç»ˆåœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª txnï¼Œ è·³è¿‡å»ï¼Œ è¿›å…¥äº†kv.go, æ‰¾åˆ°è¯¥æ–¹æ³•å®ç°

func (s *tikvStore) Begin() (kv.Transaction, error) {
	txn, err := newTiKVTxn(s)
	if err != nil {
		return nil, errors.Trace(err)
	}
	return txn, nil
}
// BeginWithStartTS begins a transaction with startTS.
func (s *tikvStore) BeginWithStartTS(startTS uint64) (kv.Transaction, error) {
	txn, err := newTikvTxnWithStartTS(s, startTS, s.nextReplicaReadSeed())
	if err != nil {
		return nil, errors.Trace(err)
	}
	return txn, nil
}

// OKï¼Œ çœ‹åˆ°æ³¨é‡Šï¼Œ ç”¨startTSå¼€å§‹ä¸€ä¸ªäº‹åŠ¡ï¼Œ 
// æ³¨æ„åˆ°è¯¥æ–¹æ³•ä¸Šé¢è¿˜æœ‰ä¸€ä¸ªæ²¡æœ‰startTSå‚æ•°çš„Beginæ–¹æ³•ï¼Œ 
// å¥½äº†å®šä½åˆ°ä»£ç ï¼Œ å¼€å§‹ä¸‹ä¸€æ­¥ä¿®æ”¹
```

#### ä¿®æ”¹âœï¸ 

```go
// kv.go
// æ—¢ç„¶æœ‰ Begin å’Œ BeginWithStartTS ä¸¤ä¸ªå¼€å§‹äº‹åŠ¡çš„æ–¹æ³•
// é‚£ä¹ˆä¸¤å¤„éƒ½ä¿®æ”¹ä¸€ä¸‹å¥½äº†
// åœ¨æˆåŠŸæ‹¿åˆ°txnåï¼Œ è¿”å›txnå‰ï¼Œ å¢åŠ ä¸€ä¸ªæ‰“å°è¾“å‡º
// ä¿®æ”¹å

func (s *tikvStore) Begin() (kv.Transaction, error) {
	txn, err := newTiKVTxn(s)
	if err != nil {
		return nil, errors.Trace(err)
	}
	logutil.BgLogger().Info(" ::---->1 Hello, Transation")
	return txn, nil
}
// BeginWithStartTS begins a transaction with startTS.
func (s *tikvStore) BeginWithStartTS(startTS uint64) (kv.Transaction, error) {
	txn, err := newTikvTxnWithStartTS(s, startTS, s.nextReplicaReadSeed())
	if err != nil {
		return nil, errors.Trace(err)
	}
	logutil.BgLogger().Info(" ::---->2 Hello, Transation")
	return txn, nil
}
```

#### é‡æ–°ç¼–è¯‘

```bash
make

# tidb-server tidb-server/main.go
# Build TiDB Server successfully!
# Okï¼Œ å¾ˆå¿«ç¼–è¯‘å®Œ
```

#### é‡æ–°å¯åŠ¨æœåŠ¡

```bash
# è®¾ç½®ä¸‹ç¯å¢ƒå˜é‡
Workspace=/opt/Projects
PD=${Workspace}/pd/bin
TIKV=${Workspace}/tikv/target/debug
TIDB=${Workspace}/tidb/bin
export PATH=$PATH:${PD}:${TIKV}:${TIDB}

# æ¸…ç©ºä¸€ä¸‹
cd /opt/cluster
rm -rf *

# è¿™æ¬¡åœ¨åå°å¯åŠ¨æœåŠ¡

# å¯åŠ¨PD
nohup pd-server \
	--name=pd1 \
	--data-dir=pd1 \
	--client-urls="http://127.0.0.1:2379" \
	--peer-urls="http://127.0.0.1:2380" \
	--initial-cluster="pd1=http://127.0.0.1:2380" \
	--log-file=pd1.log \
	&

# å¯åŠ¨TiKV

nohup tikv-server \
	--pd-endpoints="127.0.0.1:2379" \
	--addr="127.0.0.1:20160" \
	--data-dir=tikv1 \
	--log-file=tikv1.log \
	&

nohup tikv-server \
	--pd-endpoints="127.0.0.1:2379" \
	--addr="127.0.0.1:20161" \
	--data-dir=tikv2 \
	--log-file=tikv2.log \
	&

nohup tikv-server \
	--pd-endpoints="127.0.0.1:2379" \
	--addr="127.0.0.1:20162" \
	--data-dir=tikv3 \
	--log-file=tikv3.log \
	&
	
# éªŒè¯
pd-ctl store | grep "Up"
# Ok

# å¯åŠ¨TiDB
# ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ—¥å¿—ï¼Œç›´æ¥è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°, å¹¶ç”¨grepè¿‡æ»¤
tidb-server \
	--store=tikv \
	--path="127.0.0.1:2379" \
	| grep "::---->"

#
# å¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¸€ç›´äº¤æ›¿æ‰“å°
# *** ::---->1 Hello, Transation
# *** ::---->2 Hello, Transation

```

![Hello Transaction Screenshot](./2020.08.12-Lesson01/2020.08.12-Lesson01-hellotxn.png)

#### ä¸ºä»€ä¹ˆå¯åŠ¨åä¸€ç›´æ‰“å°

> æ‰“å°è°ƒç”¨å †æ ˆçœ‹ä¸€ä¸‹

```log
[2020/08/16 12:06:06.579 +08:00] [INFO] [kv.go:287] [" ::---->1 Hello, Transation"]
::----> goroutine 323 [running]:
runtime/debug.Stack(0xc0007db020, 0x3416137, 0x1b)
	/usr/lib/go/src/runtime/debug/stack.go:24 +0x9d
github.com/pingcap/tidb/store/tikv.(*tikvStore).Begin(0xc00031b500, 0x39a9860, 0xc00011c000, 0x0, 0x0)
	/opt/Projects/tidb/store/tikv/kv.go:289 +0xc0
github.com/pingcap/tidb/kv.RunInNewTxn(0x39dcc00, 0xc00031b500, 0x203000, 0xc00001fce8, 0x0, 0x0)
	/opt/Projects/tidb/kv/txn.go:36 +0x83
github.com/pingcap/tidb/ddl.(*worker).handleDDLJobQueue(0xc0000fa060, 0xc000536640, 0x24, 0xc000e44500)
	/opt/Projects/tidb/ddl/ddl_worker.go:433 +0x152
github.com/pingcap/tidb/ddl.(*worker).start(0xc0000fa060, 0xc000536640)
	/opt/Projects/tidb/ddl/ddl_worker.go:154 +0x369
created by github.com/pingcap/tidb/ddl.(*ddl).Start
	/opt/Projects/tidb/ddl/ddl.go:340 +0x67f
[2020/08/16 12:06:06.693 +08:00] [INFO] [kv.go:299] [" ::---->2 Hello, Transation"]
::----> goroutine 399 [running]:
runtime/debug.Stack(0xc0007db020, 0x3416152, 0x1b)
	/usr/lib/go/src/runtime/debug/stack.go:24 +0x9d
github.com/pingcap/tidb/store/tikv.(*tikvStore).BeginWithStartTS(0xc00031b500, 0x5cfd5c8a8f00001, 0x0, 0x0, 0xa, 0xa)
	/opt/Projects/tidb/store/tikv/kv.go:300 +0xe0
github.com/pingcap/tidb/session.(*txnFuture).wait(0xc000e23100, 0xc000e4c890, 0x11e5906, 0x5f38b0ae, 0x7fd52918c944)
	/opt/Projects/tidb/session/txn.go:373 +0x344
github.com/pingcap/tidb/session.(*TxnState).changePendingToValid(0xc00047d690, 0xbda8ef4c, 0x542e540)
	/opt/Projects/tidb/session/txn.go:169 +0x51
github.com/pingcap/tidb/session.(*session).Txn(0xc00047d680, 0xc0000bb601, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1434 +0x183
github.com/pingcap/tidb/executor.(*executorBuilder).getSnapshotTS(0xc000e44e40, 0xa, 0xc000e64870, 0x1)
	/opt/Projects/tidb/executor/builder.go:1337 +0x73
github.com/pingcap/tidb/executor.buildNoRangeIndexLookUpReader(0xc000e44e40, 0xc000e663c0, 0x40, 0x545ec20, 0x0)
	/opt/Projects/tidb/executor/builder.go:2662 +0x1c7
github.com/pingcap/tidb/executor.(*executorBuilder).buildIndexLookUpReader(0xc000e44e40, 0xc000e663c0, 0xc000e4cd30, 0x118adc4)
	/opt/Projects/tidb/executor/builder.go:2722 +0x89
github.com/pingcap/tidb/executor.(*executorBuilder).build(0xc000e44e40, 0x39d8800, 0xc000e663c0, 0x39d8800, 0xc000e663c0)
	/opt/Projects/tidb/executor/builder.go:213 +0x353
github.com/pingcap/tidb/executor.(*executorBuilder).buildProjection(0xc000e44e40, 0xc000e6a1e0, 0x39d8800, 0xc000e4cf08)
	/opt/Projects/tidb/executor/builder.go:1296 +0x91
github.com/pingcap/tidb/executor.(*executorBuilder).build(0xc000e44e40, 0x39d8c80, 0xc000e6a1e0, 0xc000e6a1e0, 0x0)
	/opt/Projects/tidb/executor/builder.go:197 +0x4db
github.com/pingcap/tidb/executor.(*ExecStmt).buildExecutor(0xc000cf1b00, 0xc0000bb600, 0x39ec960, 0xc00047d680, 0x39a98e0)
	/opt/Projects/tidb/executor/adapter.go:705 +0x160
github.com/pingcap/tidb/executor.(*ExecStmt).Exec(0xc000cf1b00, 0x39a98e0, 0xc000e1fc50, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/executor/adapter.go:315 +0x195
github.com/pingcap/tidb/session.runStmt(0x39a98e0, 0xc000e1f3b0, 0xc00047d680, 0x39b2da0, 0xc000cf1b00, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1197 +0x2a8
github.com/pingcap/tidb/session.(*session).ExecuteStmt(0xc00047d680, 0x39a98e0, 0xc000e1f3b0, 0x39b25a0, 0xc000e50000, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1162 +0x89e
github.com/pingcap/tidb/session.(*session).Execute(0xc00047d680, 0x39a98e0, 0xc000e1f3b0, 0xc000289200, 0xbb, 0x0, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1075 +0x317
github.com/pingcap/tidb/session.execRestrictedSQL(0x39a98e0, 0xc000e1f3b0, 0xc00047d680, 0xc000289200, 0xbb, 0x11a8b0f, 0xbb, 0xc000289200, 0xbb, 0xc000289200, ...)
	/opt/Projects/tidb/session/session.go:829 +0x115
github.com/pingcap/tidb/session.(*session).ExecRestrictedSQLWithContext(0xc00029b590, 0x39a9860, 0xc00011c008, 0xc000289200, 0xbb, 0x0, 0x0, 0x0, 0x0, 0x0, ...)
	/opt/Projects/tidb/session/session.go:768 +0x208
github.com/pingcap/tidb/session.(*session).ExecRestrictedSQL(0xc00029b590, 0xc000289200, 0xbb, 0x7fd575277cf0, 0xc00029b590, 0xc000289200, 0xbb, 0x33da49d, 0x1, 0xc00002e9a0, ...)
	/opt/Projects/tidb/session/session.go:738 +0x61
github.com/pingcap/tidb/bindinfo.(*BindHandle).Update(0xc00090b280, 0xc00073e600, 0x0, 0x0)
	/opt/Projects/tidb/bindinfo/handle.go:137 +0x152
github.com/pingcap/tidb/domain.(*Domain).globalBindHandleWorkerLoop.func1(0xc00058e120)
	/opt/Projects/tidb/domain/domain.go:935 +0x17a
created by github.com/pingcap/tidb/domain.(*Domain).globalBindHandleWorkerLoop
	/opt/Projects/tidb/domain/domain.go:922 +0x5f
[2020/08/16 12:06:09.765 +08:00] [INFO] [kv.go:299] [" ::---->2 Hello, Transation"]
::----> goroutine 483 [running]:
runtime/debug.Stack(0xc0007db020, 0x3416152, 0x1b)
	/usr/lib/go/src/runtime/debug/stack.go:24 +0x9d
github.com/pingcap/tidb/store/tikv.(*tikvStore).BeginWithStartTS(0xc00031b500, 0x5cfd5c8d9600001, 0x0, 0x0, 0x5, 0x5)
	/opt/Projects/tidb/store/tikv/kv.go:300 +0xe0
github.com/pingcap/tidb/session.(*txnFuture).wait(0xc000928360, 0xc000b48538, 0x11e5906, 0x5f38b0b1, 0x7fd52d956914)
	/opt/Projects/tidb/session/txn.go:373 +0x344
github.com/pingcap/tidb/session.(*TxnState).changePendingToValid(0xc00047d690, 0x174f5ed1e, 0x542e540)
	/opt/Projects/tidb/session/txn.go:169 +0x51
github.com/pingcap/tidb/session.(*session).Txn(0xc00047d680, 0xc0000bb601, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1434 +0x183
github.com/pingcap/tidb/executor.(*executorBuilder).getSnapshotTS(0xc000497fc0, 0x5, 0xc000ba4c30, 0x1)
	/opt/Projects/tidb/executor/builder.go:1337 +0x73
github.com/pingcap/tidb/executor.buildNoRangeIndexLookUpReader(0xc000497fc0, 0xc000457e00, 0x40, 0x545ec20, 0x0)
	/opt/Projects/tidb/executor/builder.go:2662 +0x1c7
github.com/pingcap/tidb/executor.(*executorBuilder).buildIndexLookUpReader(0xc000497fc0, 0xc000457e00, 0xc000b489d8, 0x118adc4)
	/opt/Projects/tidb/executor/builder.go:2722 +0x89
github.com/pingcap/tidb/executor.(*executorBuilder).build(0xc000497fc0, 0x39d8800, 0xc000457e00, 0x39d8800, 0xc000457e00)
	/opt/Projects/tidb/executor/builder.go:213 +0x353
github.com/pingcap/tidb/executor.(*executorBuilder).buildProjection(0xc000497fc0, 0xc000cb3360, 0x39d8800, 0xc000b48bb0)
	/opt/Projects/tidb/executor/builder.go:1296 +0x91
github.com/pingcap/tidb/executor.(*executorBuilder).build(0xc000497fc0, 0x39d8c80, 0xc000cb3360, 0xc000cb3360, 0x0)
	/opt/Projects/tidb/executor/builder.go:197 +0x4db
github.com/pingcap/tidb/executor.(*ExecStmt).buildExecutor(0xc000577290, 0xc0000bb600, 0x39ec960, 0xc00047d680, 0x39a98e0)
	/opt/Projects/tidb/executor/adapter.go:705 +0x160
github.com/pingcap/tidb/executor.(*ExecStmt).Exec(0xc000577290, 0x39a98e0, 0xc000552a20, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/executor/adapter.go:315 +0x195
github.com/pingcap/tidb/session.runStmt(0x39a98e0, 0xc00074cf30, 0xc00047d680, 0x39b2da0, 0xc000577290, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1197 +0x2a8
github.com/pingcap/tidb/session.(*session).ExecuteStmt(0xc00047d680, 0x39a98e0, 0xc00074cf30, 0x39b25a0, 0xc000e51520, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1162 +0x89e
github.com/pingcap/tidb/session.(*session).Execute(0xc00047d680, 0x39a98e0, 0xc00074cf30, 0xc00007e4d0, 0x66, 0x0, 0x0, 0x0, 0x0, 0x0)
	/opt/Projects/tidb/session/session.go:1075 +0x317
github.com/pingcap/tidb/session.execRestrictedSQL(0x39a98e0, 0xc00074cf30, 0xc00047d680, 0xc00007e4d0, 0x66, 0xc000d872b0, 0x0, 0xc000cd8000, 0x0, 0x10000c00011c008, ...)
	/opt/Projects/tidb/session/session.go:829 +0x115
github.com/pingcap/tidb/session.(*session).ExecRestrictedSQLWithContext(0xc000c82d20, 0x39a9860, 0xc00011c008, 0xc00007e4d0, 0x66, 0x0, 0x0, 0x0, 0x0, 0x0, ...)
	/opt/Projects/tidb/session/session.go:768 +0x208
github.com/pingcap/tidb/session.(*session).ExecRestrictedSQL(0xc000c82d20, 0xc00007e4d0, 0x66, 0x1, 0x1, 0xc00007e4d0, 0x66, 0x203000, 0x0, 0x0, ...)
	/opt/Projects/tidb/session/session.go:738 +0x61
github.com/pingcap/tidb/statistics/handle.(*Handle).Update(0xc000c81d40, 0x39e1540, 0xc0004bcb40, 0x39e1540, 0xc0004bcb40)
	/opt/Projects/tidb/statistics/handle/handle.go:177 +0x19c
github.com/pingcap/tidb/domain.(*Domain).loadStatsWorker(0xc00058e120)
	/opt/Projects/tidb/domain/domain.go:1099 +0x4a2
created by github.com/pingcap/tidb/domain.(*Domain).UpdateTableStatsLoop
	/opt/Projects/tidb/domain/domain.go:1044 +0x249

```

#### åˆ†æ

```go
// æ‰¾åˆ° domain.go:1044é™„è¿‘


// RunAutoAnalyze indicates if this TiDB server starts auto analyze worker and can run auto analyze job.
var RunAutoAnalyze = true

// UpdateTableStatsLoop creates a goroutine loads stats info and updates stats info in a loop.
// It will also start a goroutine to analyze tables automatically.
// It should be called only once in BootstrapSession.
func (do *Domain) UpdateTableStatsLoop(ctx sessionctx.Context) error {
	// ...
}

// Ok, åŸæ¥æ˜¯é»˜è®¤å¼€å¯äº†è‡ªåŠ¨åˆ†æ, å®ƒä¼šå¾ªç¯åŠ è½½å’Œæ›´æ–°ä¿¡æ¯
```

## âœï¸ å…­ã€é—®é¢˜æ€»ç»“

> ç›®å‰éƒ½æ˜¯ç½‘ç»œé—®é¢˜

#### ç¼–è¯‘TiKVæœ‰ç‚¹æ…¢(è¶…æ—¶)

> æ›¿æ¢[ä¸­ç§‘å¤§]å›½å†…æº

```bash
tee $HOME/.cargo/config <<-'EOF'
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'ustc'
[source.ustc]
registry = "git://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

#### æ„å»ºè¿‡ç¨‹æ‹‰å–éƒ¨åˆ† Github ä»“åº“æºç æ—¶ä¸€ç›´è¶…æ—¶é”™è¯¯

```text
Linuxç¿»å¢™æœ‰äº›éº»çƒ¦ï¼Œ ç”¨æ‰‹æœºçƒ­ç‚¹è§£å†³ã€‚
```
